pipeline {
  agent any

  environment {
    AWS_REGION         = 'us-west-2'
    TF_VAR_environment = 'prod'
    TF_VAR_region      = "${AWS_REGION}"
    TFVARS_FILE        = 'prod.tfvars'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Plan Destruction') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'AWS_INFRA_CREDS',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          dir('environments/prod') {
            script {
              sh 'terraform init -input=false -reconfigure'
              sh 'terraform workspace select prod'
              // Generate a plan specifically for destruction
              sh "terraform plan -destroy -var-file=${TFVARS_FILE} -out=destroy.tfplan"
            }
          }
        }
      }
    }

    stage('Manual Approval') {
      steps {
        input message: "‚ö†Ô∏è WARNING: Are you sure you want to DESTROY StreamlinePay Prod Infra?", 
              ok: "Yes, Terminate Everything"
      }
    }

    stage('Terraform Destroy') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'AWS_INFRA_CREDS',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          dir('environments/prod') {
            // Apply the destruction plan generated in the previous stage
            sh 'terraform apply -auto-approve destroy.tfplan'
          }
        }
      }
    }
  }

  post {
    always {
      echo 'üßπ Cleaning up local plan files...'
      sh 'rm -f environments/prod/destroy.tfplan'
    }
    success {
      echo 'üõë StreamlinePay Infrastructure has been successfully decommissioned.'
    }
    failure {
      echo '‚ö†Ô∏è Infrastructure destruction failed or was partially completed. Manual intervention required.'
    }
  }
}